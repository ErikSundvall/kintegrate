<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Kintegrate</title>
    <link rel="stylesheet" href="resizable-columns.css">
    <!-- CodeMirror 5 CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@widgetjs/tree/dist/tree.min.css">

  </head>
  <body>
    <!--header>
      <p>K!ntegrate</p>
    </header -->
    <main>
      <div class="fullheight-container" id="main-container">
        <div id="input-container" class="column column-left">
            <!-- file picker that can pick files from user upload -->
            Pick example file <input type="file" id="fileInput" accept=".json,.xml,.txt"><br>
            or select example:
            <!-- Dropdown that can load any existing file in web server side subdirectory /example/instance into the textarea that has id="inputInstance"  -->
            <select id="exampleSelect">
              <option value="">--Select an example--</option>
              <option value="MDK_Rek_demo1.json">MDK_Rek_demo1.json</option>
              <option value="mdk_lunga_1.json">mdk_lunga_1.json</option>
              <option value="non_existing_example.json">non_existing_example.json</option>
            </select><br>
            or just paste input into the box below<br>
            <textarea id="inputInstance">Input example goes here</textarea>
            <hr>
            <div id="json-tree-container">Parsed input from above goes here into a foldable tree. The tree-branches can then be clicked to get paths that can be used in conversion template</div>
        </div>
        <div class="resizer"></div>
        <div id="conversion-container" class="column column-center">
            <h2>Conversion Template (Handlebars)</h2>
            <textarea id="template-editor">
{{!-- 
  This is the column where you author (and possibly compile) your conversion script.
  Currently you see a simple Handlebars template.
  After importing instance data and/or schema (or other structure defitnitions) they can help you author the conversion script.
  Select nodes in the tree on the left to insert paths to data elements at the current cursor position in this template.
  
  Example: {{granskning.bakgrund.0.sjukdomshistoria.0.ospecificerad_händelse.0.anamnes.0.['|value']}}
--}}
Språk: {{ctx.language}}
Land: {{ctx.territory}} 

            </textarea>
        <button id="run-conversion">Run Conversion --- > Output</button>
        <button id="show-compiled">Show precompiled template</button>
      </div>
        <div class="resizer"></div>
        <div id="output-container" class="column column-right">
            <textarea id="out">Output goes here after conversion is run</textarea>
        </div>
      </div>
      <footer>
          <strong>K!ntegrate</strong> v0.1 A rudimentary integration tool with roots at <strong><a href="https://www.karolinskahospital.com/">K</a></a></strong>. Settings:
          <label style="cursor: pointer;">
            <input type="checkbox" id="toggle-line-numbers" checked> Show line numbers
          </label>
      </footer>
    </main>
 
    <!-- CodeMirror 5 JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/xml/xml.min.js"></script><!-- If we want HTML+XML highlight too -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/javascript/javascript.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/htmlmixed/htmlmixed.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/handlebars/handlebars.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@widget-js/core@24.1.1-beta.72/dist/widget.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@widgetjs/tree/dist/tree.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@widget-js/core@24.1.1-beta.72/dist/widget.min.js"></script>

    <!-- Handlebars Runtime -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/handlebars.js/4.7.8/handlebars.min.js"></script>
    
    <!-- Other scripts -->
    <script src="resizable-columns.js"></script>
    <script>
      // --- Helper function to build a Handlebars-compatible path ---
      function buildHandlebarsPath(pathArray) {
        if (!pathArray || pathArray.length === 0) return '';
        let pathStr = pathArray[0];
        for (let i = 1; i < pathArray.length; i++) {
          const segment = pathArray[i];
          if (typeof segment === 'number') {
            pathStr += `.${segment}`;
          } else if (/^[a-zA-Z_$][a-zA-Z0-9_$]*$/.test(segment)) {
            pathStr += `.${segment}`;
          } else {
            pathStr += `['${segment}']`;
          }
        }
        return pathStr;
      }

      // --- Simple multi-select JSON tree viewer (replaces external tree lib) ---
      const jsonTreeContainer = document.getElementById('json-tree-container');
      let selectedPaths = [];

      // Utility to create a DOM-safe label for a key
      function escapeHtml(str) {
        return String(str)
          .replace(/&/g, '&amp;')
          .replace(/</g, '&lt;')
          .replace(/>/g, '&gt;')
          .replace(/"/g, '&quot;')
          .replace(/'/g, '&#039;');
      }

      function renderJsonTree(value, container, path = []) {
        const type = Object.prototype.toString.call(value);
        if (type === '[object Object]') {
          const ul = document.createElement('ul');
          ul.className = 'json-tree';
          for (const key of Object.keys(value)) {
            const li = document.createElement('li');
            const nodePath = path.concat(key);
            const span = document.createElement('span');
            span.className = 'tree-node';
            span.dataset.path = JSON.stringify(nodePath);
            span.innerHTML = `<strong>${escapeHtml(key)}</strong>`;
            span.addEventListener('click', treeNodeClick);
            li.appendChild(span);
            // recursively render children
            const child = document.createElement('div');
            child.className = 'child-container';
            renderJsonTree(value[key], child, nodePath);
            li.appendChild(child);
            ul.appendChild(li);
          }
          container.appendChild(ul);
        } else if (type === '[object Array]') {
          const ul = document.createElement('ul');
          ul.className = 'json-tree';
          for (let i = 0; i < value.length; i++) {
            const li = document.createElement('li');
            const nodePath = path.concat(i);
            const span = document.createElement('span');
            span.className = 'tree-node';
            span.dataset.path = JSON.stringify(nodePath);
            span.textContent = `[${i}]`;
            span.addEventListener('click', treeNodeClick);
            li.appendChild(span);
            const child = document.createElement('div');
            child.className = 'child-container';
            renderJsonTree(value[i], child, nodePath);
            li.appendChild(child);
            ul.appendChild(li);
          }
          container.appendChild(ul);
        } else {
          // primitive
          const span = document.createElement('span');
          span.className = 'tree-node leaf';
          span.dataset.path = JSON.stringify(path);
          span.textContent = String(value);
          span.addEventListener('click', treeNodeClick);
          container.appendChild(span);
        }
      }

      function clearJsonTree() {
        jsonTreeContainer.innerHTML = '';
      }

      async function tryUseTreeJS(jsonData) {
        // Try to dynamically import treejs from unpkg (ESM). If successful, attempt several common
        // initialization patterns used by UMD/ESM libraries. If anything fails, return false so caller
        // can fall back to the local renderer.
        try {
          const moduleUrl = 'https://unpkg.com/@widgetjs/tree?module';
          const mod = await import(moduleUrl);
          const TreeLib = mod.default || mod.Tree || mod.createTree || mod.tree || mod;

          // If we have a constructor-like export, try several ways of creating a tree.
          const target = document.createElement('div');
          target.className = 'tree-root';

          // Provide a small API adapter so TreeLib can call our onSelect callback.
          const adapterOnSelect = (node) => {
            // Depending on the tree lib, node may contain a path or key; try to normalize.
            if (node && node.path) {
              const path = node.path;
              templateEditor.replaceSelection(`{{${buildHandlebarsPath(path)}}}`);
              templateEditor.focus();
            } else if (node && node.key && node.parentPath) {
              const path = node.parentPath.concat(node.key);
              templateEditor.replaceSelection(`{{${buildHandlebarsPath(path)}}}`);
              templateEditor.focus();
            }
          };

          // Try constructor(new TreeLib(target, {data, ...}))
          try {
            if (typeof TreeLib === 'function') {
              // Try a couple of common signatures
              try {
                new TreeLib(target, { data: jsonData, multiSelect: true, onSelect: adapterOnSelect });
                return target;
              } catch (e) {
                // Try alternative signature
                try {
                  TreeLib(target, jsonData);
                  return target;
                } catch (e2) {
                  // continue to other attempts
                }
              }
            }

            // Try if module exposes a render/create function
            if (TreeLib && typeof TreeLib.create === 'function') {
              TreeLib.create(target, { data: jsonData, multiSelect: true, onSelect: adapterOnSelect });
              return target;
            }

            if (TreeLib && typeof TreeLib.render === 'function') {
              TreeLib.render(target, jsonData);
              return target;
            }

          } catch (e) {
            console.warn('treejs integration attempts failed:', e);
          }

          return false;
        } catch (err) {
          console.warn('Could not import @widgetjs/tree from CDN, falling back to built-in renderer.', err);
          return false;
        }
      }

      async function updateJsonTree(jsonString) {
        clearJsonTree();
        selectedPaths = [];
        try {
          const jsonData = JSON.parse(jsonString);

          // First try to render using the external treejs library from CDN.
          const treeEl = await tryUseTreeJS(jsonData);
          if (treeEl) {
            // If treejs returned a DOM element, attach actions area and mount it.
            const actions = document.createElement('div');
            actions.className = 'tree-actions';
            const insertButton = document.createElement('button');
            insertButton.textContent = 'Insert Selected Paths';
            insertButton.id = 'insert-selected-paths';
            insertButton.addEventListener('click', insertSelectedPathsAtCursor);
            const selectedList = document.createElement('div');
            selectedList.id = 'selected-paths';
            selectedList.style.marginTop = '8px';
            actions.appendChild(insertButton);
            actions.appendChild(selectedList);
            jsonTreeContainer.appendChild(actions);

            jsonTreeContainer.appendChild(treeEl);
            // Best-effort: attempt to wire up click delegation for nodes that expose data-path attributes
            jsonTreeContainer.addEventListener('click', function delegatedClick(e) {
              const el = e.target.closest('[data-path]');
              if (el) {
                try {
                  const path = JSON.parse(el.getAttribute('data-path'));
                  const handlebarsPath = buildHandlebarsPath(path);
                  if (handlebarsPath) {
                    templateEditor.replaceSelection(`{{${handlebarsPath}}}`);
                    templateEditor.focus();
                  }
                } catch (ex) {
                  // ignore
                }
              }
            });

            // done
            refreshSelectedPathsUI();
            return;
          }

          // Fallback to built-in renderer
          const actions = document.createElement('div');
          actions.className = 'tree-actions';
          const insertButton = document.createElement('button');
          insertButton.textContent = 'Insert Selected Paths';
          insertButton.id = 'insert-selected-paths';
          insertButton.addEventListener('click', insertSelectedPathsAtCursor);
          const selectedList = document.createElement('div');
          selectedList.id = 'selected-paths';
          selectedList.style.marginTop = '8px';
          actions.appendChild(insertButton);
          actions.appendChild(selectedList);
          jsonTreeContainer.appendChild(actions);

          const treeRoot = document.createElement('div');
          treeRoot.className = 'tree-root';
          renderJsonTree(jsonData, treeRoot, []);
          jsonTreeContainer.appendChild(treeRoot);

        } catch (e) {
          jsonTreeContainer.innerHTML = '<p style="color:red;">Invalid JSON. Error message:<br>'+e.message+'</p>';
        }
        refreshSelectedPathsUI();
      }

      function treeNodeClick(ev) {
        ev.stopPropagation();
        const el = ev.currentTarget;
        const path = JSON.parse(el.dataset.path || '[]');
        const pathStr = JSON.stringify(path);

        if (ev.ctrlKey || ev.metaKey) {
          // toggle selection
          const idx = selectedPaths.findIndex(p => JSON.stringify(p) === pathStr);
          if (idx === -1) selectedPaths.push(path);
          else selectedPaths.splice(idx, 1);
          el.classList.toggle('selected');
          refreshSelectedPathsUI();
          return;
        }

        // No modifier: single selection, insert immediately
        const handlebarsPath = buildHandlebarsPath(path);
        if (handlebarsPath) {
          templateEditor.replaceSelection(`{{${handlebarsPath}}}`);
          templateEditor.focus();
        }
      }

      function refreshSelectedPathsUI() {
        const selectedList = document.getElementById('selected-paths');
        if (!selectedList) return;
        selectedList.innerHTML = '';
        if (selectedPaths.length === 0) {
          selectedList.textContent = 'No nodes selected. (Ctrl/Cmd + click to multi-select)';
          return;
        }
        const ul = document.createElement('ul');
        for (const p of selectedPaths) {
          const li = document.createElement('li');
          const btn = document.createElement('button');
          btn.textContent = buildHandlebarsPath(p);
          btn.style.cursor = 'pointer';
          btn.addEventListener('click', () => {
            templateEditor.replaceSelection(`{{${buildHandlebarsPath(p)}}}`);
            templateEditor.focus();
          });
          li.appendChild(btn);
          ul.appendChild(li);
        }
        selectedList.appendChild(ul);
      }

      function insertSelectedPathsAtCursor() {
        if (!selectedPaths || selectedPaths.length === 0) return;
        const inserts = selectedPaths.map(p => `{{${buildHandlebarsPath(p)}}}`);
        templateEditor.replaceSelection(inserts.join('\n'));
        templateEditor.focus();
      }

      // --- Initialize CodeMirror Editors ---
      const templateEditor = CodeMirror.fromTextArea(document.getElementById('template-editor'), {
        lineNumbers: true,
        mode: { name: 'handlebars', base: 'text/html' },
      });

      const inputEditor = CodeMirror.fromTextArea(document.getElementById('inputInstance'), {
        lineNumbers: true,
        mode: { name: 'javascript', json: true },
      });

      const outputEditor = CodeMirror.fromTextArea(document.getElementById('out'), {
        lineNumbers: true,
        mode: 'htmlmixed',
        readOnly: true
      });

      // Set initial content
      const initialJson = '{\n  "message": "Paste JSON here or select an example.",\n  "tip": "Click a node below to copy its path to the cursor/selection in the conversion template."\n}';
      inputEditor.setValue(initialJson);
      outputEditor.setValue('Output goes here after conversion is run.');

      // --- Event Handlers ---
      document.getElementById('run-conversion').addEventListener('click', () => {
        try {
          // 1. Get template and input from editors
          const templateString = templateEditor.getValue();
          const jsonString = inputEditor.getValue();

          if (!jsonString.trim()) {
            outputEditor.setValue('Input JSON is empty.');
            return;
          }
          const data = JSON.parse(jsonString);

          // 2. Compile the template
          const template = Handlebars.compile(templateString);

          // 3. Execute the template with the data
          const resultHtml = template(data);

          // 4. Display the resulting HTML in the output editor
          outputEditor.setValue(resultHtml);
        } catch (e) {
          outputEditor.setValue(`Error during conversion:\n\n${e.message}`);
          console.error("Conversion Error:", e);
        }
      });

      document.getElementById('fileInput').addEventListener('change', function() {
        const file = this.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const content = e.target.result;
                inputEditor.setValue(content);
                updateJsonTree(content); // Manually update tree
            };
            reader.readAsText(file);
        }
      });

      document.getElementById('exampleSelect').addEventListener('change', function() {
        const selectedFile = this.value;
        if (selectedFile) {
            fetch(`example/instance/${selectedFile}`)
                .then(response => response.ok ? response.text() : Promise.reject('Network response was not ok'))
                .then(data => {
                    inputEditor.setValue(data);
                    updateJsonTree(data); // Manually update tree
                })
                .catch(error => {
                    console.error('There was a problem with the fetch operation:', error);
                    const msg = 'Error loading file: ' + selectedFile;
                    inputEditor.setValue(`{"error": "${msg}"}`);
                });
        }
      });

      // when show-compiled button is clicked, show the compiled template
      var showCompiledButton = document.getElementById('show-compiled');
      showCompiledButton.addEventListener('click', () => {
        const templateString = templateEditor.getValue();
        try {
          var precompiledTemplate = Handlebars.precompile(templateString);
          console.log("Precompiled template string:", precompiledTemplate);
          // insert a textarea in the conversion-container under the show-conmpiled button, 
          const conversionContainer = document.getElementById('conversion-container');
          const compiledTextarea = document.createElement('textarea');
          compiledTextarea.id = 'precompiled-textarea';
          compiledTextarea.style.width = '100%';
          compiledTextarea.style.height = '50%';
          compiledTextarea.readOnly = true;
          compiledTextarea.value = precompiledTemplate;
          conversionContainer.insertBefore(compiledTextarea, showCompiledButton);
          showCompiledButton.style.display = 'none'; // hide the button after click
          // add a copy to clipboard button to the alert that copies the template to clipboard
          const copyButton = document.createElement('button');
          copyButton.textContent = 'Copy precompiled template to Clipboard (+close)';
          copyButton.id = 'copy-precompiled-button';
          conversionContainer.appendChild(copyButton);
          copyButton.style.cursor = 'pointer';
          copyButton.onclick = () => {
            navigator.clipboard.writeText(precompiledTemplate).then(() => {
              // show text "Copied!" on the button for 1 second then remove the textarea and copy button;
              copyButton.textContent = 'Copied!';
              setTimeout(() => {
                conversionContainer.removeChild(compiledTextarea);
                conversionContainer.removeChild(copyButton);
                showCompiledButton.style.display = 'inline'; // show the show-compiled button again
              }, 1000);
            });
          };
        } catch (e) {
          alert('Error during precompilation:\n\n' + e.message);
          console.error("Precompilation Error:", e);
        }
      });

      // When content of template-editor changes: If compiled-textarea exists, remove it + copy buttonand show the show-compiled button again

      templateEditor.on('change', () => {
        console.log("Template editor changed, removing precompiled view if exists.");
        const conversionContainer = document.getElementById('conversion-container');
        const compiledTextarea = document.getElementById('precompiled-textarea');
        const copyButton = document.getElementById('copy-precompiled-button');
        console.log("Compiled textarea:", compiledTextarea);
        if (compiledTextarea && copyButton) {
          conversionContainer.removeChild(compiledTextarea);
          conversionContainer.removeChild(copyButton);
          showCompiledButton.style.display = 'inline'; // show the show-compiled button again
        }
      });


      document.getElementById('toggle-line-numbers').addEventListener('change', function() {
        const showLineNumbers = this.checked;
        const editors = [inputEditor, templateEditor, outputEditor];
        editors.forEach(editor => {
          editor.setOption('lineNumbers', showLineNumbers);
        });
      });

      // Update tree when user types in the input editor
      inputEditor.on('change', (editor) => {
        updateJsonTree(editor.getValue());
      });

      // Trigger initial render of the JSON tree
      updateJsonTree(initialJson);
    </script>
  </body>
</html>
